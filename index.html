<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/Currency/manifest.json">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Earendel-lab/Currency/main/icon.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Earendel-lab/Currency/main/icon.png">
    
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Currency</title>
    <style>
        :root {
            --bg: #000000;
            --surface: #1C1C1E;
            --accent: #D71921; 
            --text: #FFFFFF;
            --secondary-text: #8E8E93;
            --key-bg: #1C1C1E;
            --key-active: #3A3A3C;
        }

        body.light-mode {
            --bg: #F2F2F7;
            --surface: #FFFFFF;
            --text: #000000;
            --secondary-text: #636366;
            --key-bg: #E5E5EA;
            --key-active: #C7C7CC;
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: "Times New Roman", Times, Baskerville, Georgia, serif; 
            -webkit-tap-highlight-color: transparent; 
        }

        body { 
            background: var(--bg); color: var(--text); 
            height: 100dvh; display: flex; justify-content: center; 
            overflow: hidden; position: fixed; width: 100%;
            transition: background 0.3s ease;
        }

        .app-container { 
            width: 100vw; max-width: 450px; height: 100%;
            display: flex; flex-direction: column; padding: 20px; 
            padding-top: max(20px, env(safe-area-inset-top)); 
            padding-bottom: max(20px, env(safe-area-inset-bottom)); 
        }

        .top-nav { display: flex; justify-content: space-between; align-items: center; height: 44px; margin-bottom: 10px; }
        .sync-container { display: flex; align-items: center; gap: 10px; height: 100%; cursor: pointer; }
        .sync-btn-wrapper { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; }

        .sync-svg {
            width: 22px; height: 22px;
            fill: none; stroke: var(--accent);
            stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .spinning { transform: rotate(360deg); }

        .update-time { 
            font-size: 11px; color: var(--secondary-text); 
            text-transform: uppercase; font-family: sans-serif;
            letter-spacing: 0.5px;
            line-height: 32px; 
        }

        .mode-toggle { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; }
        .icon-svg { width: 22px; height: 22px; stroke: var(--text); fill: none; stroke-width: 2; }

        .display-area { flex: 1; display: flex; flex-direction: column; justify-content: center; min-height: 180px; }
        .input-wrapper { display: flex; align-items: center; justify-content: space-between; height: 70px; }
        .input-scroll { flex: 1; overflow-x: auto; overflow-y: hidden; -webkit-overflow-scrolling: touch; display: flex; align-items: center; min-width: 0; }
        
        #val-in { white-space: nowrap; min-width: fit-content; }
        
        #val-in { font-size: 52px; font-weight: 300; color: var(--text); border: none; background: transparent; outline: none; width: 75%; text-align: left; transition: font-size 0.2s ease; }
        .result-amt { font-size: 60px; font-weight: 200; color: var(--accent); width: 75%; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; transition: font-size 0.2s ease; }
        .code-tag { font-family: sans-serif; font-weight: 700; color: var(--secondary-text); font-size: 18px; }
        .rate-ref { border-top: 1px solid var(--key-bg); padding-top: 8px; font-size: 15px; color: var(--secondary-text); margin-bottom: 15px; }

        .selector-box { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; position: relative; height: 64px; }
        .pick-btn { flex: 1; background: var(--key-bg); height: 100%; border-radius: 20px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.1s; }
        .pick-btn:active { transform: scale(0.96); }
        .pick-label { font-size: 10px; color: var(--secondary-text); text-transform: uppercase; font-family: sans-serif; }
        
        .swap-circle { 
            width: 44px; height: 44px; background: var(--accent); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; z-index: 5; 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            color: white; border: 4px solid var(--bg); cursor: pointer;
            transition: transform 0.4s ease;
        }
        .swap-circle.rotate { transform: translate(-50%, -50%) rotate(180deg); }

        .keypad-grid { display: grid; grid-template-columns: 2.8fr 1.2fr; gap: 12px; height: 360px; }
        .numeric-zone { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .action-zone { display: flex; flex-direction: column; gap: 12px; }
        
        .key { 
            background: var(--key-bg); border-radius: 100px; display: flex; justify-content: center; 
            align-items: center; font-size: 30px; cursor: pointer; user-select: none;
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background 0.1s ease;
        }
        .numeric-zone .key { aspect-ratio: 1/1; }
        .action-zone .key { flex: 1; border-radius: 100px; width: 100%; }

        .key:active { background: var(--key-active); transform: scale(0.92); }
        .pill-ac { background: var(--accent); color: white; font-weight: 700; font-size: 24px; }
        .pill-del { color: var(--accent); font-size: 30px; }

        #picker-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: var(--bg); z-index: 1000; display: none; flex-direction: column; padding: 20px; padding-top: env(safe-area-inset-top); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-family: sans-serif; }
        .search-in { background: var(--key-bg); border: none; padding: 18px; border-radius: 20px; color: var(--text); width: 100%; margin-bottom: 15px; font-size: 18px; outline: none; }
        
        .country-list { flex: 1; overflow-y: scroll; -webkit-overflow-scrolling: touch; }
        .country-item { padding: 20px; border-bottom: 1px solid var(--key-bg); display: flex; justify-content: space-between; align-items: center; font-family: sans-serif; cursor: pointer; }
        .star-box { padding: 10px; }
        .star-svg { width: 24px; height: 24px; fill: none; stroke: var(--secondary-text); stroke-width: 2; transition: 0.2s; }
        .star-svg.active { fill: var(--accent); stroke: var(--accent); }


    </style>
</head>
<body>

<div id="picker-modal">
    <div class="modal-header">
        <h2>Select Country</h2>
        <span onclick="closePicker()" style="font-size: 45px; cursor: pointer;">×</span>
    </div>
    <input type="text" id="search-box" class="search-in" placeholder="Search country..." oninput="filterCountries(this.value)">
    <div class="country-list" id="country-list"></div>
</div>

<div class="app-container">
    <div class="top-nav">
        <div class="sync-container" onclick="fetchRates()">
            <div class="sync-btn-wrapper">
                <svg class="sync-svg" id="sync-icon" viewBox="0 0 24 24">
                    <path d="M23 4v6h-6"></path>
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                </svg>
            </div>
            <div>
                <div class="update-time" id="last-update">OFFLINE</div>
            </div>
        </div>
        <div class="mode-toggle" id="mode-icon" onclick="toggleTheme()"></div>
    </div>

    <div class="display-area">
        <div class="input-wrapper">
            <div class="input-scroll">
                <input type="text" id="val-in" value="1" readonly>
            </div>
            <div id="code-in" class="code-tag">USD</div>
        </div>
        <div class="rate-ref" id="rate-line">1 USD = ---</div>
        <div class="input-wrapper">
            <div class="result-amt" id="val-out">0.00</div>
            <div id="code-out" class="code-tag">SAR</div>
        </div>
    </div>

    <div class="selector-box">
        <div class="pick-btn" onclick="openPicker('from')">
            <span class="pick-label">From</span>
            <span id="from-btn-text">USD</span>
        </div>
        <div class="swap-circle" id="swap-btn" onclick="swap()">⇅</div>
        <div class="pick-btn" onclick="openPicker('to')">
            <span class="pick-label">To</span>
            <span id="to-btn-text">SAR</span>
        </div>
    </div>

    <div class="keypad-grid">
        <div class="numeric-zone">
            <div class="key" onclick="num('7')">7</div><div class="key" onclick="num('8')">8</div><div class="key" onclick="num('9')">9</div>
            <div class="key" onclick="num('4')">4</div><div class="key" onclick="num('5')">5</div><div class="key" onclick="num('6')">6</div>
            <div class="key" onclick="num('1')">1</div><div class="key" onclick="num('2')">2</div><div class="key" onclick="num('3')">3</div>
            <div class="key" onclick="num('0')">0</div><div class="key" onclick="num('00')">00</div><div class="key" onclick="num('.')">.</div>
        </div>
        <div class="action-zone">
            <div class="key pill-ac" onclick="num('AC')">AC</div>
            <div class="key pill-del" onclick="num('DEL')">⌫</div>
        </div>
    </div>
</div>

<script>
    const API_KEY = 'a9f0a6f31913cc811264df99'; 
    
    let usdRates = JSON.parse(localStorage.getItem('fx-usd-rates')) || {};
    let countryList = JSON.parse(localStorage.getItem('fx-list')) || {};
    let favorites = JSON.parse(localStorage.getItem('fx-favs')) || [];
    let fromCode = localStorage.getItem('fx-from') || 'usd';
    let toCode = localStorage.getItem('fx-to') || 'sar';
    let rawInput = "1"; 
    let activeTarget = 'from';
    let isSyncing = false;

    const blacklist = ['btc','eth','ltc','xrp','bch','dot','link','xlm','ada','bnb','usdt','ust','sol','matic','xag','xau','xpd','xpt','std','ves','byr','cup','zrn'];

    const indFmt = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 8 });

    function haptic() {
        if (window.navigator && window.navigator.vibrate) {
            window.navigator.vibrate(10);
        }
    }

    window.addEventListener('keydown', (e) => {
        if (document.getElementById('picker-modal').style.display === 'flex') return;
        if (e.key >= '0' && e.key <= '9') num(e.key);
        if (e.key === '.') num('.');
        if (e.key === 'Backspace') num('DEL');
        if (e.key === 'Escape') num('AC');
    });

    // Handle Android back button
    document.addEventListener('backbutton', handleBackButton, false);
    window.addEventListener('popstate', handleBackButton);

    function handleBackButton(e) {
        const pickerModal = document.getElementById('picker-modal');
        if (pickerModal.style.display === 'flex') {
            // Close picker and preserve search
            closePicker();
            if (e && e.preventDefault) e.preventDefault();
        }
    }

    // Swipe detection for back and number manipulation
    let touchStartX = 0;
    let touchStartY = 0;
    let touchEndX = 0;
    let touchEndY = 0;

    document.addEventListener('touchstart', (e) => {
        touchStartX = e.changedTouches[0].screenX;
        touchStartY = e.changedTouches[0].screenY;
    }, false);

    document.addEventListener('touchend', (e) => {
        touchEndX = e.changedTouches[0].screenX;
        touchEndY = e.changedTouches[0].screenY;
        handleSwipe(e);
    }, false);

    function handleSwipe(e) {
        const pickerModal = document.getElementById('picker-modal');
        const diffX = touchEndX - touchStartX;  // Changed: Right swipe is positive, Left is negative
        const diffY = touchEndY - touchStartY;
        
        // Only consider horizontal swipes (ignore if more vertical movement)
        if (Math.abs(diffY) > Math.abs(diffX) * 0.5) return;

        // Swipe in picker modal - prevent back closing
        if (pickerModal.style.display === 'flex') {
            if (diffX > 50) {
                // Swiped right - close picker instead of closing app
                closePicker();
                if (e && e.preventDefault) e.preventDefault();
                return;
            } else if (diffX < -50) {
                // Swiped left - do nothing in modal, prevent default back
                if (e && e.preventDefault) e.preventDefault();
                return;
            }
        }

        // Swipe on home screen for number manipulation
        if (pickerModal.style.display !== 'flex') {
            if (diffX > 50) {
                // Swiped right - delete last number (DEL)
                num('DEL');
            } else if (diffX < -50) {
                // Swiped left - clear all (AC)
                num('AC');
            }
        }
    }

    function formatIndian(valStr) {
        if (!valStr || valStr === "0") return "0";
        if (valStr.endsWith('.')) {
            const num = parseFloat(valStr.slice(0, -1));
            return indFmt.format(num) + ".";
        }
        if (valStr.includes('.')) {
            const parts = valStr.split('.');
            const head = indFmt.format(parseFloat(parts[0]));
            return head + "." + parts[1];
        }
        return indFmt.format(parseFloat(valStr));
    }

    function showSyncStatus(message) {
        // Removed - no UI feedback needed
    }

    async function init() {
        if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        updateThemeIcon();
        
        // Display last known update time and rates
        const lastSync = localStorage.getItem('fx-last-sync-time');
        if (lastSync) {
            document.getElementById('last-update').innerText = lastSync;
        }

        try {
            const res = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/codes`);
            const data = await res.json();
            const filtered = {};
            data.supported_codes.forEach(c => {
                const code = c[0].toLowerCase();
                if (!blacklist.includes(code)) filtered[code] = c[1];
            });
            countryList = filtered;
            localStorage.setItem('fx-list', JSON.stringify(countryList));
        } catch(e) {
            console.log("Offline or API Error loading country list");
        }

        // Fetch fresh rates on app open
        await fetchRates();

        // Register Service Worker for Offline capability
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/Currency/sw.js')
                .then(reg => console.log('Offline Ready'))
                .catch(err => console.log('SW Registration failed', err));
            });
        }
    }

    async function fetchRates() {
        if (isSyncing) return; // Prevent multiple simultaneous syncs
        
        haptic();
        isSyncing = true;
        const icon = document.getElementById('sync-icon');
        icon.classList.add('spinning');
        
        try {
            const res = await fetch(`https://v6.exchangerate-api.com/v6/${API_KEY}/latest/USD`);
            const data = await res.json();
            
            if(data.result === "success") {
                // Update all rates
                for(let c in data.conversion_rates) {
                    usdRates[c.toLowerCase()] = data.conversion_rates[c];
                }
                localStorage.setItem('fx-usd-rates', JSON.stringify(usdRates));
                
                // Update timestamp
                const now = new Date();
                const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                localStorage.setItem('fx-last-sync-time', timeStr);
                document.getElementById('last-update').innerText = timeStr;
                
                // Recalculate and display with fresh rates
                convert();
                showSyncStatus('Updated ✓');
            } else {
                showSyncStatus('Sync failed');
                console.log("API Error:", data);
            }
        } catch (e) {
            console.log("Connection error. Using cached rates.");
            // Still update the display with cached rates
            document.getElementById('last-update').innerText = localStorage.getItem('fx-last-sync-time') || "OFFLINE";
            convert();
            showSyncStatus('Offline');
        }
        
        isSyncing = false;
        setTimeout(() => icon.classList.remove('spinning'), 800);
    }

    function num(k) {
        haptic();
        if (k === 'AC') rawInput = "0";
        else if (k === 'DEL') rawInput = rawInput.length > 1 ? rawInput.slice(0, -1) : "0";
        else {
            if (rawInput === "0" && k !== '.') rawInput = k;
            else if (k === '.' && rawInput.includes('.')) return;
            else if (rawInput.length < 15) rawInput += k;
        }
        convert();
    }

    function convert() {
        const inputEl = document.getElementById('val-in');
        const outputEl = document.getElementById('val-out');
        const scrollContainer = document.querySelector('.input-scroll');
        
        document.getElementById('from-btn-text').innerText = fromCode.toUpperCase();
        document.getElementById('to-btn-text').innerText = toCode.toUpperCase();
        document.getElementById('code-in').innerText = fromCode.toUpperCase();
        document.getElementById('code-out').innerText = toCode.toUpperCase();
        
        const formattedInput = formatIndian(rawInput);
        inputEl.value = formattedInput;
        
        // Auto-scroll to the end on input
        setTimeout(() => {
            if (scrollContainer) {
                scrollContainer.scrollLeft = inputEl.scrollWidth;
            }
        }, 0);
        
        // Get rates with fallback to 1 if not available
        const rFrom = usdRates[fromCode.toLowerCase()] || 1;
        const rTo = usdRates[toCode.toLowerCase()] || 1;
        const finalRate = rTo / rFrom;

        document.getElementById('rate-line').innerText = `1 ${fromCode.toUpperCase()} = ${finalRate.toFixed(4)} ${toCode.toUpperCase()}`;
        
        // Parse the raw input (without commas) for calculation
        const cleanInput = rawInput.replace(/,/g, '');
        let resVal = parseFloat(cleanInput) * finalRate;
        const formattedOut = isNaN(resVal) ? "0.00" : new Intl.NumberFormat('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(resVal);
        outputEl.innerText = formattedOut;
        
        const inLen = formattedInput.length;
        inputEl.style.fontSize = inLen > 12 ? '28px' : inLen > 9 ? '38px' : '52px';

        const outLen = formattedOut.length;
        outputEl.style.fontSize = outLen > 12 ? '32px' : outLen > 9 ? '42px' : '60px';
    }

    function openPicker(t) { haptic(); activeTarget = t; document.getElementById('picker-modal').style.display = 'flex'; document.getElementById('search-box').value = ''; filterCountries(''); }
    function closePicker() { haptic(); document.getElementById('picker-modal').style.display = 'none'; document.getElementById('search-box').value = ''; }

    function toggleFav(e, code) {
        haptic();
        e.stopPropagation();
        favorites = favorites.includes(code) ? favorites.filter(f => f !== code) : [...favorites, code];
        localStorage.setItem('fx-favs', JSON.stringify(favorites));
        filterCountries(document.getElementById('search-box').value);
    }

    function filterCountries(q) {
        const container = document.getElementById('country-list');
        container.innerHTML = '';
        const search = q.toLowerCase();
        Object.keys(countryList).sort((a,b) => {
            const af = favorites.includes(a), bf = favorites.includes(b);
            return af === bf ? a.localeCompare(b) : af ? -1 : 1;
        }).forEach(code => {
            if (code.includes(search) || countryList[code].toLowerCase().includes(search)) {
                const item = document.createElement('div');
                item.className = 'country-item';
                item.onclick = () => { 
                    if(activeTarget === 'from') fromCode = code; else toCode = code;
                    localStorage.setItem('fx-from', fromCode); localStorage.setItem('fx-to', toCode);
                    closePicker(); convert();
                };
                item.innerHTML = `<div><div style="font-weight:600;">${countryList[code]}</div><div style="font-size:12px;color:var(--secondary-text);">${code.toUpperCase()}</div></div>
                    <div class="star-box" onclick="toggleFav(event, '${code}')"><svg class="star-svg ${favorites.includes(code)?'active':''}" viewBox="0 0 24 24"><path d="M12 2l2.4 7.4h7.8l-6.3 4.6 2.4 7.4-6.3-4.6-6.3 4.6 2.4-7.4-6.3-4.6h7.8z"/></svg></div>`;
                container.appendChild(item);
            }
        });
    }

    function swap() {
        haptic();
        const btn = document.getElementById('swap-btn');
        btn.classList.add('rotate'); setTimeout(() => btn.classList.remove('rotate'), 400);
        [fromCode, toCode] = [toCode, fromCode];
        localStorage.setItem('fx-from', fromCode); localStorage.setItem('fx-to', toCode);
        convert();
    }

    function toggleTheme() {
        haptic();
        const isLight = document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', isLight ? 'light' : 'dark');
        updateThemeIcon();
    }

    function updateThemeIcon() {
        const moon = `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
        const sun = `<svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
        document.getElementById('mode-icon').innerHTML = document.body.classList.contains('light-mode') ? moon : sun;
    }

    init();
</script>
</body>
</html>
