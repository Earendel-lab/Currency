<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="/Currency/manifest.json">
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Earendel-lab/Currency/main/icon.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/Earendel-lab/Currency/main/icon.png">
    
    <meta name="theme-color" content="#000000">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Currency</title>
    <style>
        :root {
            --bg: #000000;
            --surface: #1C1C1E;
            --accent: #D71921; 
            --text: #FFFFFF;
            --secondary-text: #8E8E93;
            --key-bg: #1C1C1E;
            --key-active: #3A3A3C;
        }

        body.light-mode {
            --bg: #F2F2F7;
            --surface: #FFFFFF;
            --text: #000000;
            --secondary-text: #636366;
            --key-bg: #E5E5EA;
            --key-active: #C7C7CC;
        }

        * { 
            margin: 0; padding: 0; box-sizing: border-box; 
            font-family: "Times New Roman", Times, Baskerville, Georgia, serif; 
            -webkit-tap-highlight-color: transparent; 
            touch-action: manipulation;
        }

        body { 
            background: var(--bg); color: var(--text); 
            height: 100vh; height: 100dvh; 
            display: flex; justify-content: center; 
            overflow: hidden; position: fixed; width: 100%;
            transition: background 0.3s ease;
        }

        .app-container { 
            width: 100%; max-width: 450px; height: 100%;
            display: flex; flex-direction: column; padding: 15px; 
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-bottom: max(15px, env(safe-area-inset-bottom)); 
        }

        .top-nav { display: flex; justify-content: space-between; align-items: center; height: 40px; margin-bottom: 5px; }
        .sync-container { display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .sync-btn-wrapper { width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }

        .sync-svg {
            width: 20px; height: 20px;
            fill: none; stroke: var(--accent);
            stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .spinning { transform: rotate(360deg); }

        .update-time { 
            font-size: 10px; color: var(--secondary-text); 
            text-transform: uppercase; font-family: sans-serif;
            letter-spacing: 0.5px;
        }

        .mode-toggle { cursor: pointer; display: flex; align-items: center; justify-content: center; width: 40px; height: 40px; }
        .icon-svg { width: 20px; height: 20px; stroke: var(--text); fill: none; stroke-width: 2; }

        .display-area { flex: 1; display: flex; flex-direction: column; justify-content: space-evenly; min-height: 0; }
        .input-wrapper { display: flex; align-items: center; justify-content: space-between; height: 60px; gap: 8px; }
        .input-scroll { 
            flex: 1; 
            overflow-x: auto; 
            overflow-y: hidden; 
            display: flex; 
            align-items: center; 
            scrollbar-width: none;
        }
        
        .input-scroll::-webkit-scrollbar { display: none; }
        
        #val-in { 
            font-size: 48px; 
            font-weight: 300; 
            color: var(--text); 
            border: none; 
            background: transparent; 
            outline: none; 
            width: 100%;
        }

        .is-placeholder { opacity: 0.35; }
        
        .result-amt { 
            font-size: 54px; 
            font-weight: 200; 
            color: var(--accent); 
            overflow-x: auto;
            white-space: nowrap; 
            scrollbar-width: none;
        }
        
        .result-amt::-webkit-scrollbar { display: none; }
        
        .code-tag { font-family: sans-serif; font-weight: 700; color: var(--secondary-text); font-size: 16px; flex-shrink: 0; }
        .rate-ref { border-top: 1px solid var(--key-bg); padding-top: 5px; font-size: 13px; color: var(--secondary-text); }

        .selector-box { display: flex; align-items: center; gap: 10px; margin: 15px 0; position: relative; height: 56px; }
        .pick-btn { flex: 1; background: var(--key-bg); height: 100%; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
        .pick-label { font-size: 9px; color: var(--secondary-text); text-transform: uppercase; font-family: sans-serif; }
        
        .swap-circle { 
            width: 40px; height: 40px; background: var(--accent); border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; z-index: 5; 
            position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); 
            color: white; border: 3px solid var(--bg); cursor: pointer;
        }

        .keypad-grid { display: grid; grid-template-columns: 3fr 1fr; gap: 10px; height: 320px; }
        .numeric-zone { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .action-zone { display: flex; flex-direction: column; gap: 10px; }
        
        .key { 
            background: var(--key-bg); border-radius: 50%; display: flex; justify-content: center; 
            align-items: center; font-size: 24px; cursor: pointer; user-select: none;
        }
        .action-zone .key { border-radius: 40px; flex: 1; }

        .key:active { background: var(--key-active); opacity: 0.7; }
        .pill-ac { background: var(--accent); color: white; font-weight: 700; }
        .pill-del { color: var(--accent); }

        #picker-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100dvh; background: var(--bg); z-index: 1000; display: none; flex-direction: column; padding: 20px; padding-top: env(safe-area-inset-top); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .search-in { background: var(--key-bg); border: none; padding: 15px; border-radius: 15px; color: var(--text); width: 100%; margin-bottom: 15px; font-size: 16px; outline: none; }
        
        .country-list { flex: 1; overflow-y: auto; }
        .country-item { padding: 15px; border-bottom: 1px solid var(--key-bg); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .star-svg { width: 20px; height: 20px; fill: none; stroke: var(--secondary-text); stroke-width: 2; }
        .star-svg.active { fill: var(--accent); stroke: var(--accent); }
    </style>
</head>
<body>

<div id="picker-modal">
    <div class="modal-header">
        <h2>Select Country</h2>
        <span onclick="closePicker()" style="font-size: 35px; cursor: pointer;">×</span>
    </div>
    <input type="text" id="search-box" class="search-in" placeholder="Search..." oninput="filterCountries(this.value)">
    <div class="country-list" id="country-list"></div>
</div>

<div class="app-container">
    <div class="top-nav">
        <div class="sync-container" onclick="fetchRates()">
            <div class="sync-btn-wrapper"><svg class="sync-svg" id="sync-icon" viewBox="0 0 24 24"><path d="M23 4v6h-6"></path><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path></svg></div>
            <div class="update-time" id="last-update">OFFLINE</div>
        </div>
        <div class="mode-toggle" id="mode-icon" onclick="toggleTheme()"></div>
    </div>

    <div class="display-area">
        <div class="input-wrapper">
            <div class="input-scroll"><input type="text" id="val-in" value="1" readonly></div>
            <div id="code-in" class="code-tag">USD</div>
        </div>
        <div class="rate-ref" id="rate-line">1 USD = ---</div>
        <div class="input-wrapper">
            <div class="result-amt" id="val-out">0.00</div>
            <div id="code-out" class="code-tag">SAR</div>
        </div>
    </div>

    <div class="selector-box">
        <div class="pick-btn" onclick="openPicker('from')"><span class="pick-label">From</span><span id="from-btn-text">USD</span></div>
        <div class="swap-circle" id="swap-btn" onclick="swap()">⇅</div>
        <div class="pick-btn" onclick="openPicker('to')"><span class="pick-label">To</span><span id="to-btn-text">SAR</span></div>
    </div>

    <div class="keypad-grid">
        <div class="numeric-zone">
            <div class="key" onclick="num('7')">7</div><div class="key" onclick="num('8')">8</div><div class="key" onclick="num('9')">9</div>
            <div class="key" onclick="num('4')">4</div><div class="key" onclick="num('5')">5</div><div class="key" onclick="num('6')">6</div>
            <div class="key" onclick="num('1')">1</div><div class="key" onclick="num('2')">2</div><div class="key" onclick="num('3')">3</div>
            <div class="key" onclick="num('0')">0</div><div class="key" onclick="num('00')">00</div><div class="key" onclick="num('.')">.</div>
        </div>
        <div class="action-zone">
            <div class="key pill-ac" onclick="num('AC')">AC</div>
            <div class="key pill-del" onclick="num('DEL')">⌫</div>
        </div>
    </div>
</div>

<script>
let usdRates = JSON.parse(localStorage.getItem('fx-usd-rates')) || {};
let countryList = JSON.parse(localStorage.getItem('fx-list')) || {};
let favorites = JSON.parse(localStorage.getItem('fx-favs')) || [];
let fromCode = localStorage.getItem('fx-from') || 'usd';
let toCode = localStorage.getItem('fx-to') || 'sar';
let rawInput = "1"; 
let isInitialState = true;
let activeTarget = 'from';
let isSyncing = false;

const blacklist = ['btc','eth','ltc','xrp','bch','dot','link','xlm','ada','bnb','usdt','ust','sol','matic','xag','xau','xpd','xpt','std','ves','byr','cup','zrn'];
const indFmt = new Intl.NumberFormat('en-IN', { maximumFractionDigits: 8 });

function haptic() { if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(10); }

async function init() {
    if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
    updateThemeIcon();
    window.addEventListener('hashchange', () => {
        if (!window.location.hash.includes('picker')) document.getElementById('picker-modal').style.display = 'none';
    });
    const lastSyncLabel = localStorage.getItem('fx-last-sync-label');
    if (lastSyncLabel) document.getElementById('last-update').innerText = lastSyncLabel;
    try {
        const res = await fetch(`https://openexchangerates.org/api/currencies.json`);
        const data = await res.json();
        const filtered = {};
        for (let code in data) { if (!blacklist.includes(code.toLowerCase())) filtered[code.toLowerCase()] = data[code]; }
        countryList = filtered;
        localStorage.setItem('fx-list', JSON.stringify(countryList));
    } catch(e) {}
    await fetchRates();
}

async function fetchRates() {
    if (isSyncing) return;
    isSyncing = true;
    const icon = document.getElementById('sync-icon');
    icon.classList.add('spinning');
    try {
        const res = await fetch('https://raw.githubusercontent.com/Earendel-lab/Currency/main/rates.json');
        const data = await res.json();
        if(data.rates) {
            for(let c in data.rates) usdRates[c.toLowerCase()] = data.rates[c];
            localStorage.setItem('fx-usd-rates', JSON.stringify(usdRates));
            const timeStr = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            localStorage.setItem('fx-last-sync-label', timeStr);
            document.getElementById('last-update').innerText = timeStr;
            convert();
        }
    } catch (e) { convert(); }
    isSyncing = false;
    setTimeout(() => icon.classList.remove('spinning'), 800);
}

function num(k) {
    haptic();
    const inputEl = document.getElementById('val-in');
    if (k === 'AC') { rawInput = "0"; isInitialState = true; inputEl.classList.add('is-placeholder'); }
    else if (k === 'DEL') { rawInput = rawInput.length > 1 ? rawInput.slice(0, -1) : "0"; if (rawInput === "0") { isInitialState = true; inputEl.classList.add('is-placeholder'); } }
    else {
        if (isInitialState) {
            if (k === '.') { rawInput = "0."; isInitialState = false; inputEl.classList.remove('is-placeholder'); }
            else if (k === '00' || k === '0') { rawInput = "0"; }
            else { rawInput = k; isInitialState = false; inputEl.classList.remove('is-placeholder'); }
        } else {
            if (k === '.' && rawInput.includes('.')) return;
            if (rawInput.length < 15) rawInput += k;
        }
    }
    convert();
}

function convert() {
    const inputEl = document.getElementById('val-in');
    const outputEl = document.getElementById('val-out');
    document.getElementById('from-btn-text').innerText = fromCode.toUpperCase();
    document.getElementById('to-btn-text').innerText = toCode.toUpperCase();
    document.getElementById('code-in').innerText = fromCode.toUpperCase();
    document.getElementById('code-out').innerText = toCode.toUpperCase();
    const formattedInput = formatIndian(rawInput);
    inputEl.value = formattedInput;
    const finalRate = (usdRates[toCode.toLowerCase()] || 1) / (usdRates[fromCode.toLowerCase()] || 1);
    document.getElementById('rate-line').innerText = `1 ${fromCode.toUpperCase()} = ${finalRate.toFixed(4)} ${toCode.toUpperCase()}`;
    let resVal = parseFloat(rawInput.replace(/,/g, '')) * finalRate;
    outputEl.innerText = isNaN(resVal) ? "0.00" : new Intl.NumberFormat('en-IN', {minimumFractionDigits: 2, maximumFractionDigits: 2}).format(resVal);
}

function formatIndian(valStr) {
    if (!valStr || valStr === "0") return "0";
    if (valStr.endsWith('.')) return indFmt.format(parseFloat(valStr.slice(0, -1))) + ".";
    if (valStr.includes('.')) { const parts = valStr.split('.'); return indFmt.format(parseFloat(parts[0])) + "." + parts[1]; }
    return indFmt.format(parseFloat(valStr));
}

function openPicker(t) { haptic(); activeTarget = t; document.getElementById('picker-modal').style.display = 'flex'; filterCountries(''); window.location.hash = "picker"; }
function closePicker() { haptic(); if (window.location.hash === "#picker") window.history.back(); else document.getElementById('picker-modal').style.display = 'none'; }
function toggleFav(e, code) { e.stopPropagation(); favorites = favorites.includes(code) ? favorites.filter(f => f !== code) : [...favorites, code]; localStorage.setItem('fx-favs', JSON.stringify(favorites)); filterCountries(document.getElementById('search-box').value); }

function filterCountries(q) {
    const container = document.getElementById('country-list');
    container.innerHTML = '';
    const search = q.toLowerCase();
    Object.keys(countryList).sort((a,b) => { const af = favorites.includes(a), bf = favorites.includes(b); return af === bf ? a.localeCompare(b) : af ? -1 : 1; }).forEach(code => {
        if (code.includes(search) || countryList[code].toLowerCase().includes(search)) {
            const item = document.createElement('div');
            item.className = 'country-item';
            item.onclick = () => { if(activeTarget === 'from') fromCode = code; else toCode = code; localStorage.setItem('fx-from', fromCode); localStorage.setItem('fx-to', toCode); closePicker(); convert(); };
            item.innerHTML = `<div><div style="font-weight:600;">${countryList[code]}</div><div style="font-size:12px;color:var(--secondary-text);">${code.toUpperCase()}</div></div><div onclick="toggleFav(event, '${code}')"><svg class="star-svg ${favorites.includes(code)?'active':''}" viewBox="0 0 24 24"><path d="M12 2l2.4 7.4h7.8l-6.3 4.6 2.4 7.4-6.3-4.6-6.3 4.6 2.4-7.4-6.3-4.6h7.8z"/></svg></div>`;
            container.appendChild(item);
        }
    });
}

function swap() { haptic(); [fromCode, toCode] = [toCode, fromCode]; localStorage.setItem('fx-from', fromCode); localStorage.setItem('fx-to', toCode); convert(); }
function toggleTheme() { haptic(); const isLight = document.body.classList.toggle('light-mode'); localStorage.setItem('theme', isLight ? 'light' : 'dark'); updateThemeIcon(); }
function updateThemeIcon() {
    const moon = `<svg class="icon-svg" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>`;
    const sun = `<svg class="icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>`;
    document.getElementById('mode-icon').innerHTML = document.body.classList.contains('light-mode') ? moon : sun;
}
init();
</script>
</body>
</html>
